# CS615 HW3 Capturing DNS Traffic

## Setup

### EC2 Instances

I started by creating two EC2 instances using the provided NetBSD ami (ami-0018b2d98332ba7e3). I created them inside the VPC/subnet I created for the prior assignment with the same security groups so they are IPv6 enabled. I modified the security group to allow TCP/UDP traffic on port 53 for DNS.

### DNS Server

Since I used the NetBSD instance, I just added `named=YES` in `/etc/rc.conf` with `vi`. I also changed the nameserver in `/etc/resolv.conf` to `127.0.0.1`. I then ran:

```sh
$ /etc/rc.d/named start
Generating rndc.key
wrote key file "/etc/rndc.key"
Starting named.
```

To verify this worked, I ran:

```sh
netbsd# nslookup www.google.com
Server:         127.0.0.1
Address:        127.0.0.1#53

Non-authoritative answer:
Name:   www.google.com
Address: 172.217.15.68
Name:   www.google.com
Address: 2607:f8b0:4004:810::2004
```

Now that this part is taken care of, I can run `tcpdump(8)` as a background task. This will let me bring it to foreground later.

```sh
netbsd# tcpdump -w temp.dump > /dev/null 2>&1 &
...
netbsd# fg 
netbsd# ^C
netbsd# tcpdump -n -r temp.dump
```

### DNS Client

I switched the nameserver in `/etc/resolv.conf` using vi as shown here:

```sh
netbsd# cat /etc/resolv.conf
# Generated by resolvconf
nameserver 100.25.152.80
```

Where 100.25.152.80 is the public IP of my DNS server.

Before I did the activity, I wanted to verify the DNS caching was working with:

```sh
netbsd# nslookup www.netbsd.org
Server:         100.25.152.80
Address:        100.25.152.80#53

** server can't find www.netbsd.org: REFUSED
```

Turns out I forgot to change `options` in `/etc/named.conf` and uncomment `query-source address * port 53;` and to change `allow-recursion` to `any`.

I started by running `tcpdump(8)` as a background job on my client instance.

```sh
netbsd# tcpdump -w temp.dump > /dev/null 2>&1 &
...
netbsd# fg 
netbsd# ^C
netbsd# tcpdump -n -r temp.dump
```

## Analysis

To get the files onto my computer, I used

```sh
$ scp -i aws.pem root@ec2-100-25-152-80.compute-1.amazonaws.com:temp.dump server.dump
$ scp -i aws.pem root@ec2-54-174-105-90.compute-1.amazonaws.com:temp.dump client.dump
```

One thing I didn't quite understanding looking through the logs is it looked like my machines were being probed by external machines throughout the execution. I removed most of these from my analysis files as there was a lot. Also there was everything over SSH and Port 22 with my ongoing connection. In retrospect I should have specified 'not port 22' in the `tcpdump(8)`. Additionally, I though the IPv6 router advertisement was interesting. I really enjoyed looking through the HTTP/1.0 headers on the darpa request to see how the protocol has evolved.

I used Wireshark to analyze the packets and exported the annotated plaintext to do the annotations on.

## Sources

https://www.netbsd.org/docs/guide/en/chap-dns.html
https://en.wikipedia.org/wiki/List_of_HTTP_header_fields
